function modweebChat(options){const HUGGING_FACE_TOKEN=options.config.hfToken,HUGGING_FACE_MODEL=options.config.hfModel,USAGE_KEY="modweebChatUsage_v1",HISTORY_KEY="modweebChatHistory_v1",DEFAULT_DAILY_LIMIT=25,DEV_FLAG_KEY="modweebDevUnlimited_v1";const WIDGET_HTML=`\n        <button id="modweeb-chat-btn" type="button" class="modweeb-chat-btn" aria-label="فتح الدردشة" title="ابدأ دردشة AI">\n            <svg class="modweeb-svg-btn-n" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n                <path d="M21.49 12C21.81 10.98 22 9.88 22 8.69C22 5.6 19.51 3.09998 16.44 3.09998C14.62 3.09998 13.01 3.98003 12 5.34003C10.99 3.98003 9.37 3.09998 7.56 3.09998C4.49 3.09998 2 5.6 2 8.69C2 15.69 8.48 19.82 11.38 20.82C11.55 20.88 11.77 20.91 12 20.91"></path>\n                <path d="M19.21 15.74L15.67 19.2801C15.53 19.4201 15.4 19.68 15.37 19.87L15.18 21.22C15.11 21.71 15.45 22.05 15.94 21.98L17.29 21.79C17.48 21.76 17.75 21.63 17.88 21.49L21.42 17.95C22.03 17.34 22.32 16.63 21.42 15.73C20.53 14.84 19.82 15.13 19.21 15.74Z" stroke-miterlimit="10"></path>\n                <path d="M18.7001 16.25C19.0001 17.33 19.8401 18.17 20.9201 18.47" stroke-miterlimit="10"></path>\n            </svg>\n        </button>\n        <div id="modweeb-widget-container">\n            <div id="modweeb-chat-container" role="dialog" aria-label="دردشة الذكاء الاصطناعي">\n                <div id="modweeb-status" aria-live="polite"></div>\n                <div class="modweeb-head" id="modweeb-head">\n                    <span>\n                        <svg class="line" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M10.75 2.44995C11.45 1.85995 12.58 1.85995 13.26 2.44995L14.84 3.79995C15.14 4.04995 15.71 4.25995 16.11 4.25995H17.81C18.87 4.25995 19.74 5.12995 19.74 6.18995V7.88995C19.74 8.28995 19.95 8.84995 20.2 9.14995L21.55 10.7299C22.14 11.4299 22.14 12.5599 21.55 13.2399L20.2 14.8199C19.95 15.1199 19.74 15.6799 19.74 16.0799V17.7799C19.74 18.8399 18.87 19.7099 17.81 19.7099H16.11C15.71 19.7099 15.15 19.9199 14.85 20.1699L13.27 21.5199C12.57 22.1099 11.44 22.1099 10.76 21.5199L9.18001 20.1699C8.88001 19.9199 8.31 19.7099 7.92 19.7099H6.17C5.11 19.7099 4.24 18.8399 4.24 17.7799V16.0699C4.24 15.6799 4.04 15.1099 3.79 14.8199L2.44 13.2299C1.86 12.5399 1.86 11.4199 2.44 10.7299L3.79 9.13995C4.04 8.83995 4.24 8.27995 4.24 7.88995V6.19995C4.24 5.13995 5.11 4.26995 6.17 4.26995H7.9C8.3 4.26995 8.86 4.05995 9.16 3.80995L10.75 2.44995Z"></path>\n                            <path d="M8.5 15.9401L12 8.06006L15.5 15.9401"></path>\n                            <path d="M13.75 13.3101H10.25"></path>\n                        </svg>\n                        Gemma AI Chat\n                    </span>\n                    <div style="display:flex;align-items:center;gap:6px">\n                        <div class="modweeb-usage" id="modweeb-usage">\n                            <span id="modweeb-remaining">الرسائل المتبقية: --</span>\n                            <span id="modweeb-chars">0 أحرف</span>\n                        </div>\n                        <button id="modweeb-chat-close" title="غلق">\n                            <svg class="line" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                <path d="M12 22C17.5 22 22 17.5 22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22Z"></path>\n                                <path d="M9.16998 14.83L14.83 9.17004"></path>\n                                <path d="M14.83 14.83L9.16998 9.17004"></path>\n                            </svg>\n                        </button>\n                    </div>\n                </div>\n                <div class="modweeb-suggestions" aria-hidden="false">\n                    <button class="modweeb-suggestion-btn">كيف أحسن سرعة مدونتي؟</button>\n                    <button class="modweeb-suggestion-btn">ما أفضل إضافات SEO؟</button>\n                </div>\n                <div id="modweeb-messages" aria-live="polite"></div>\n                <div class="modweeb-input-wrap">\n                    <textarea id="modweeb-input" rows="1" maxlength="300" placeholder="اكتب رسالتك هنا..." aria-label="محتوى الرسالة" style="background:var(--contentB,#fff)"></textarea>\n                    <button id="modweeb-send" title="إرسال (Enter)">\n                        <svg class="line" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M7.39999 6.32003L15.89 3.49003C19.7 2.22003 21.77 4.30003 20.51 8.11003L17.68 16.6C15.78 22.31 12.66 22.31 10.76 16.6L9.91999 14.08L7.39999 13.24C1.68999 11.34 1.68999 8.23003 7.39999 6.32003Z"></path>\n                            <path d="M10.11 13.6501L13.69 10.0601"></path>\n                        </svg>\n                    </button>\n                </div>\n                <div class="modweeb-actions">\n                    <button id="modweeb-copy-all" title="نسخ المحادثة">\n                        <svg class="line" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M12 22C6.48 22 2 17.52 2 12C2 6.48 6.48 2 12 2C17.52 2 22 6.48 22 12C22 17.52 17.52 22 12 22Z"></path>\n                            <path d="M14.88 15C14.17 15.62 13.25 16 12.24 16C10.03 16 8.23999 14.21 8.23999 12C8.23999 9.79 10.03 8 12.24 8C13.25 8 14.17 8.38 14.88 9"></path>\n                        </svg>\n                    </button>\n                    <button id="modweeb-clear" title="حذف المحادثة">\n                        <svg class="line" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M12 22C17.5 22 22 17.5 22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22Z"></path>\n                            <path d="M9.16998 14.83L14.83 9.17004"></path>\n                            <path d="M14.83 14.83L9.16998 9.17004"></path>\n                        </svg>\n                    </button>\n                </div>\n            </div>\n        </div>\n    `;const tempDiv=document.createElement("div");tempDiv.innerHTML=WIDGET_HTML;for(;tempDiv.firstChild;)document.body.appendChild(tempDiv.firstChild);const btn=document.getElementById("modweeb-chat-btn"),container=document.getElementById("modweeb-chat-container"),messagesContainer=document.getElementById("modweeb-messages"),statusDiv=document.getElementById("modweeb-status"),inputArea=document.getElementById("modweeb-input"),sendBtn=document.getElementById("modweeb-send"),closeBtn=document.getElementById("modweeb-chat-close"),charsUI=document.getElementById("modweeb-chars"),head=document.getElementById("modweeb-head"),copyAllBtn=document.getElementById("modweeb-copy-all"),clearBtn=document.getElementById("modweeb-clear"),suggestions=document.querySelectorAll(".modweeb-suggestion-btn");function escapeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}function isSafeUrl(e){try{let t=new URL(e,location.href);return"https:"===t.protocol||"http:"===t.protocol}catch(n){return!1}}function renderRichText(e){let t=escapeHtml(e);t=t.replace(/^#{1,6}\s+(.*)$/gm,(e,t)=>`<b style="display:block; margin:15px 0 8px 0; color:var(--linkC, #2563eb);">${t.trim()}</b>`);let n=0;return(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/^[*\-]\s+(.*)$/gm,(e,t)=>{n++;let s=n<=10?["١","٢","٣","٤","٥","٦","٧","٨","٩","١٠"][n-1]:n+".";return`${s} ${t.trim()}<br>`})).replace(/(?<!\w)[*#](?!\w)/g,"")).replace(/\*\*/g,"")).replace(/\*/g,"")).replace(/!\[([^\]]*?)\]\((.*?)\)/g,(e,t,n)=>isSafeUrl(n.trim())?`<img src="${n.trim()}" alt="${escapeHtml(t)}" loading="lazy" style="max-width:100%; height:auto; border-radius:8px; margin:8px 0;">`:escapeHtml(e))).replace(/\[([^\]]+)\]\((.*?)\)/g,(e,t,n)=>isSafeUrl(n.trim())?`<a href="${n.trim()}" target="_blank" rel="noopener noreferrer" style="color:var(--linkC, #2563eb); text-decoration:underline;">${escapeHtml(t)}</a>`:escapeHtml(e))).replace(/`([^`]+)`/g,(e,t)=>`<code style="background:var(--contentBa, #f4f8ff); padding:2px 6px; border-radius:4px; border:1px solid var(--contentL, #e3e7ef);">${escapeHtml(t)}</code>`)).replace(/\*\*(.*?)\*\*/g,(e,t)=>`<b style="font-weight:600;">${escapeHtml(t)}</b>`)).replace(/\*(.*?)\*/g,(e,t)=>`<i style="font-style:italic;">${escapeHtml(t)}</i>`)).replace(/(^|\s)(https?:\/\/\S+\.(?:png|jpe?g|gif|webp|bmp))(?![^<]*>)/gi,(e,t,n)=>isSafeUrl(n)?`${t}<img src="${n}" loading="lazy" style="max-width:100%; height:auto; border-radius:8px; margin:8px 0;">`:e)).replace(/(^|\s)(https?:\/\/[^\s<]+)/g,(e,t,n)=>isSafeUrl(n)?`${t}<a href="${n}" target="_blank" rel="noopener noreferrer" style="color:var(--linkC, #2563eb); text-decoration:underline;">${escapeHtml(n)}</a>`:e)).replace(/\n\n+/g,"<br><br>")).replace(/\n/g,"<br>")).replace(/(<br>){3,}/g,"<br><br>")}function loadUsage(){try{let e=localStorage.getItem(USAGE_KEY);if(!e)return initUsage();let t=JSON.parse(e),n=new Date().toISOString().slice(0,10);if(t.date!==n)return initUsage();return t}catch(s){return initUsage()}}function initUsage(){let e=new Date().toISOString().slice(0,10),t={date:e,count:0,limit:25};return localStorage.setItem(USAGE_KEY,JSON.stringify(t)),t}function saveUsage(e){localStorage.setItem(USAGE_KEY,JSON.stringify(e))}function remainingMessages(){let e="1"===localStorage.getItem(DEV_FLAG_KEY);if(e)return 1/0;let t=loadUsage();return Math.max(0,t.limit-t.count)}function refreshUsageUI(){let e=remainingMessages();document.getElementById("modweeb-remaining").textContent=e===1/0?"غير محدود":`الرسائل المتبقية: ${e}`}let messagesLoaded=!1;function saveHistory(){try{let e=[...messagesContainer.children],t=e.map(e=>({role:e.classList.contains("modweeb-msg-user")?"user":"assistant",html:e.querySelector(".bubble")?e.querySelector(".bubble").innerHTML:e.innerHTML}));localStorage.setItem(HISTORY_KEY,JSON.stringify(t))}catch(n){}}function restoreHistory(){try{let e=localStorage.getItem(HISTORY_KEY);if(!e)return;let t=JSON.parse(e);messagesContainer.innerHTML="",t.forEach(e=>{let t=document.createElement("div");"user"===e.role?t.className="modweeb-msg-user":t.className="modweeb-msg-ai";let s=document.createElement("div");if(s.className="bubble",s.innerHTML=e.html,t.appendChild(s),"assistant"===e.role){let a=document.createElement("div");a.className="meta",a.innerHTML=`<div class="msg-controls">\n              <button class="copy-reply" title="نسخ الرد">نسخ</button>\n            </div>`,t.appendChild(a)}messagesContainer.appendChild(t)}),messagesLoaded=!0,setTimeout(()=>{messagesContainer.scrollTop=messagesContainer.scrollHeight},100)}catch(s){}}function showStatus(e,t=1600){statusDiv.style.display="block",statusDiv.textContent=e,t>0&&setTimeout(()=>{statusDiv.style.display="none"},t)}function createUserMessage(e){let t=document.createElement("div");t.className="modweeb-msg-user";let n=document.createElement("div");n.className="bubble",n.innerHTML=renderRichText(e),t.appendChild(n);let s=document.createElement("div");return s.className="meta",s.innerHTML=`<div class="msg-controls">\n        <button class="edit-user" title="تعديل">✎</button>\n      </div>`,t.appendChild(s),messagesContainer.appendChild(t),t}function createAiPlaceholder(){let e=document.createElement("div");e.className="modweeb-msg-ai";let t=document.createElement("div");t.className="bubble",t.innerHTML=`<div style="display:flex;align-items:center;gap:8px;"><div class="spinner" aria-hidden="true"></div> جاري الكتابة...</div>`,e.appendChild(t);let n=document.createElement("div");return n.className="meta",n.innerHTML=`<div class="msg-controls">\n        <button class="copy-reply" title="نسخ الرد">نسخ</button>\n        <button class="resend-retry" title="إعادة المحاولة" style="display:none">إعادة</button>\n      </div>`,e.appendChild(n),messagesContainer.appendChild(e),messagesContainer.scrollTop=messagesContainer.scrollHeight,e}function buildConversationPayload(e){let t=[...messagesContainer.children],n=[{role:"system",content:"أنت مساعد تقني لمدونة modweeb.com، أجِب بشكل مختصر وعملي واحترافي."}];return t.forEach(e=>{let t=e.classList.contains("modweeb-msg-user"),s=e.querySelector(".bubble");if(!s)return;let a=s.innerText||s.textContent||"";n.push({role:t?"user":"assistant",content:a})}),e&&n.push({role:"user",content:e}),n}async function sendMessage(e,t=null,n=!1){let s="1"===localStorage.getItem(DEV_FLAG_KEY);if(!s){let a=loadUsage();if(a.count>=a.limit)return showStatus("تم تجاوز الحد اليومي للرسائل"),!1}let l=t||createAiPlaceholder();showStatus("جاري إرسال الرسالة..."),modweebTrackEvent("chat_message_sent");let r=buildConversationPayload(e);try{let o=await fetch("https://router.huggingface.co/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${HUGGING_FACE_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify({model:HUGGING_FACE_MODEL,messages:r,max_tokens:1e3,temperature:.7,top_p:.9})});if(!o.ok)throw Error("network");let i=await o.json(),c=i?.choices?.[0]?.message?.content||"❌ حدث خطأ.",d=renderRichText(c),m=l.querySelector(".bubble");m&&(m.innerHTML=d);let g=l.querySelector(".resend-retry");g&&(g.style.display="none");let u=loadUsage();return u.count=(u.count||0)+1,saveUsage(u),refreshUsageUI(),saveHistory(),showStatus("تم الرد بنجاح!"),modweebTrackEvent("chat_message_received",{tokens:i?.usage?.total_tokens||0}),!0}catch(p){let y=l.querySelector(".bubble");y&&(y.innerHTML=`<div style="color:#ef4444;">❌ تعذر استجابة المساعد</div>`);let b=l.querySelector(".resend-retry");return b&&(b.style.display="inline-block",b.onclick=async function(){b.disabled=!0,b.textContent="...",y.innerHTML=`<div style="display:flex;align-items:center;gap:8px;"><div class="spinner"></div> إعادة المحاولة...</div>`,await sendMessage(e,l,!0),b.disabled=!1,b.textContent="إعادة"}),saveHistory(),showStatus("تعذر الاتصال بالخادم"),!1}}function lazyLoadMessages(){if(!messagesLoaded){let e=document.createElement("div");e.className="modweeb-msg-ai";let t=document.createElement("div");t.className="bubble",t.innerHTML=`👋 مرحبًا بك في دردشة <b>modweeb.com</b>! كيف أساعدك؟`,e.appendChild(t);let n=document.createElement("div");n.className="meta",n.innerHTML=`<div class="msg-controls"><button class="copy-reply" title="نسخ الرد">نسخ</button></div>`,e.appendChild(n),messagesContainer.appendChild(e),messagesLoaded=!0,modweebTrackEvent("chat_opened"),setTimeout(()=>{messagesContainer.scrollTop=messagesContainer.scrollHeight},100)}}btn.onclick=function(){container.style.display="flex",container.style.position="fixed",container.style.left="",container.style.top="",container.style.right="32px",container.style.bottom="142px",lazyLoadMessages(),setTimeout(function(){inputArea.focus()},100),window.modweebChatOpenedAt=Date.now(),refreshUsageUI(),restoreHistory()},closeBtn.onclick=function(){container.style.display="none",container.style.position="fixed",container.style.left="",container.style.top="",container.style.right="32px",container.style.bottom="142px",window.modweebChatOpenedAt&&modweebTrackEvent("chat_duration",{value:Date.now()-window.modweebChatOpenedAt})},inputArea.addEventListener("input",function(e){e.target.style.height="auto",e.target.style.height=Math.min(e.target.scrollHeight,62)+"px",charsUI.textContent=`${e.target.value.length} أحرف`}),inputArea.addEventListener("keydown",function(e){if("Enter"===e.key&&!e.shiftKey||(e.ctrlKey||e.metaKey)&&"Enter"===e.key){e.preventDefault(),sendBtn.click();return}if("ArrowUp"===e.key&&""===inputArea.value.trim()){let t=[...messagesContainer.children].reverse(),n=t.find(e=>e.classList.contains("modweeb-msg-user"));if(n){let s=n.querySelector(".bubble").innerText||"";inputArea.value=s,inputArea.dispatchEvent(new Event("input"))}}}),document.addEventListener("keydown",function(e){"Escape"===e.key&&(container.style.display="none"),(e.ctrlKey||e.metaKey)&&"k"===e.key.toLowerCase()&&(e.preventDefault(),container.style.display="flex",setTimeout(()=>inputArea.focus(),100))}),suggestions.forEach(e=>{e.onclick=()=>{inputArea.value=e.textContent,inputArea.focus(),inputArea.dispatchEvent(new Event("input"))}}),copyAllBtn.onclick=function(){let e=[...messagesContainer.children].map(e=>e.innerText).join("\n");navigator.clipboard.writeText(e).then(()=>showStatus("تم نسخ المحادثة!"))},clearBtn.onclick=function(){localStorage.removeItem(HISTORY_KEY),messagesContainer.innerHTML="",messagesLoaded=!1,lazyLoadMessages(),showStatus("تم حذف المحادثة!")},messagesContainer.addEventListener("click",function(e){let t=e.target;if(t.closest(".copy-reply")){let n=t.closest(".modweeb-msg-ai");if(!n)return;let s=n.querySelector(".bubble").innerText||"";navigator.clipboard.writeText(s).then(()=>showStatus("تم نسخ الرد!"))}if(t.closest(".edit-user")){let a=t.closest(".modweeb-msg-user");if(!a)return;let l=a.querySelector(".bubble").innerText||"";inputArea.value=l,inputArea.focus(),inputArea.dispatchEvent(new Event("input"))}}),sendBtn.onclick=async function(){let e=inputArea.value.trim();if(!e)return;let t="1"===localStorage.getItem(DEV_FLAG_KEY);if(!t){let n=loadUsage();if(n.count>=n.limit){showStatus("تم تجاوز الحد اليومي للرسائل");return}}createUserMessage(e),inputArea.value="",inputArea.style.height="auto",charsUI.textContent=`0 أحرف`;let s=createAiPlaceholder();messagesContainer.scrollTop=messagesContainer.scrollHeight,saveHistory(),await sendMessage(e,s)},restoreHistory(),refreshUsageUI();let headerClickCount=0,headerClickTimer=null;function modweebTrackEvent(e,t){window.gtag&&gtag("event",e,t||{})}function adjustForKeyboard(){let e=window.visualViewport.height,t=window.innerHeight;t-e>150?(container.style.bottom="10px",btn.style.bottom="10px"):(container.style.bottom="142px",btn.style.bottom="88px")}head.addEventListener("click",function(e){if(headerClickCount++,headerClickTimer&&clearTimeout(headerClickTimer),headerClickTimer=setTimeout(()=>{headerClickCount=0},4e3),headerClickCount>=5){headerClickCount=0;let t="1"===localStorage.getItem(DEV_FLAG_KEY);t?(localStorage.removeItem(DEV_FLAG_KEY),showStatus("وضع المطور معطل")):(localStorage.setItem(DEV_FLAG_KEY,"1"),showStatus("وضع المطور مفعل: غير محدود")),refreshUsageUI()}}),messagesContainer.style.minHeight="60px",window.visualViewport.addEventListener("resize",adjustForKeyboard),window.visualViewport.addEventListener("scroll",adjustForKeyboard),document.addEventListener("click",function(e){"flex"!==container.style.display||container.contains(e.target)||btn.contains(e.target)||(container.style.display="none")})}
